!!! 5
%html{:xmlns => "https://www.w3.org/1999/xhtml", 'xmlns:fb' => "https://www.facebook.com/2008/fbml"}
  %head
    = render 'layouts/common_head'
    = stylesheet_link_tag "main_page"
    = include_javascripts :templates


  %body{ :class => "application #{params[:controller].gsub(/\//,"_")} #{params[:action]} #{ logged_in? ? "logged_in" : "logged_out" } #{ current_community.is_college ? "is_college" : ""}"}

    #wrapper

      = render 'shared/admin_bar'

      = render 'layouts/header'

      - if !current_community.has_launched?
        .prelaunch-notification
          Hey #{current_user.first_name}, welcome to #{current_community.name} CommonPlace! We're officially launching on #{current_community.launch_date.strftime("%B")} #{current_community.launch_date.day.ordinalize}. In the meantime, help us improve by <a href="/invite">inviting some more neighbors</a>.

      #main
        #whats-happening
        #left-container
          #say-something
          #community-profiles
            = render 'accounts/info_box'
          = yield :modal

      #wrapper-footer

    = render "layouts/footer"

    = render "layouts/bottom_scripts"

    :javascript
      CommonPlace.community = new CommonPlace.Community({ id: #{current_community.id},
      name: "#{current_community.name}",
      locale: "#{current_community.locale}"
      });


      CommonPlace.community.posts.refresh(#{@posts.to_json.html_safe});

      CommonPlace.community.events.refresh(#{@events.to_json.html_safe});

      CommonPlace.community.announcements.refresh(#{@announcements.to_json.html_safe});

      CommonPlace.community.group_posts.refresh(#{@group_posts.to_json.html_safe});

      CommonPlace.community.feeds.refresh(#{@feeds.to_json.html_safe});
      CommonPlace.community.groups.refresh(#{@groups.to_json.html_safe});
      CommonPlace.community.users.refresh(#{@users.to_json.html_safe});

      CommonPlace.account = new CommonPlace.Account(#{serialize(Account.new(current_user))});

      var oldhash = window.location.hash.slice(1);
      window.location.hash = "/";

      CommonPlace.app = new CommonPlace.MainPageController({community: CommonPlace.community, account: CommonPlace.account});
      CommonPlace.app.runNotifier();
      Backbone.history.start();

      window.location.hash = "#{request.fullpath}"
      Backbone.history.loadUrl();
      if (oldhash != "" && oldhash != "/") { window.location.hash = oldhash; }


    - if logged_in?
      - unless current_user.seen_tour?
        - current_user.toggle!(:seen_tour)
        :javascript
          (new CommonPlace.Tour({el: $("#main")})).render();
    - if Rails.env.production?
      %script
        = "mpmetrics.track('Community Home Page', {'community': '#{current_community.slug}'});"
