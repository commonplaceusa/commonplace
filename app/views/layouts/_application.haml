!!! 5
%html{:xmlns => "https://www.w3.org/1999/xhtml", 'xmlns:fb' => "https://www.facebook.com/2008/fbml"}
  %head
    - if Rails.env.production?
      :javascript
        var _sf_startpt=(new Date()).getTime()
    %link{ :href=> 'https://webfonts.fontslive.com/css/0a25c9dc-bb5a-4ea9-88b2-1c7a8802e172.css', :rel =>"stylesheet", :type =>"text/css"}
    %meta{ :content => "text/html;charset=utf-8", "http-equiv" => "Content-Type" }
    %meta{ :name => "google-site-verification", :content => "HntCS6GTLIAye5nM6FCNHgtcSUlb0-aF2jVbGtd8oyI" }
    %meta{ :name => "title", :content => "" }
    %meta{ :name => "description", :content => "" }
    %link{ :href => image_path('favicon.png'), :rel => "icon", :type => "image/png" }
    %title= "CommonPlace - #{current_community.name}"

    %script{:type => 'text/javascript', :src => "/javascripts/head.min.js"}
    = javascript_include_tag "https://exceptional-js.heroku.com/exceptional.js"      
    = include_javascripts :application
    = include_javascripts :templates
    = javascript_include_tag "https://connect.facebook.net/en_US/all.js#xfbml=1"
    
    = include_stylesheets :application
    / [if IE]
      = javascript_include_tag "https://html5shiv.googlecode.com/svn/trunk/html5.js"
      = include_stylesheets :ie

  %body{ :class => "application #{params[:controller].gsub(/\//,"_")} #{params[:action]} #{ logged_in? ? "logged_in" : "logged_out" }"}
    #fb-root
    - if Rails.env.production?
      %script
        var mp_protocol = (('https:' == document.location.protocol) ? 'https://' : 'http://'); document.write(unescape('%3Cscript src="' + mp_protocol + 'api.mixpanel.com/site_media/js/api/mixpanel.js" type="text/javascript"%3E%3C/script%3E')); </script> <script type='text/javascript'> try {  var mpmetrics = new MixpanelLib('811a15fe46de2d4df84c6ee51112e7ab'); } catch(err) { null_fn = function () {}; var mpmetrics = {  track: null_fn,  track_funnel: null_fn,  register: null_fn,  register_once: null_fn, register_funnel: null_fn }; }
      - if current_user.email.present?
        %script
          mpmetrics.identify("#{current_user.email}");

    = render 'shared/admin_bar'
    
    = render 'layouts/header', :user_session => current_user_session
    - if Rails.env.production?
      :javascript
        var _kmq = _kmq || [];
        function _kms(u){
          setTimeout(function(){
            var s = document.createElement('script'); var f = document.getElementsByTagName('script')[0]; s.type = 'text/javascript'; s.async = true;
            s.src = u; f.parentNode.insertBefore(s, f);
          }, 1);
        }
        _kms('//i.kissmetrics.com/i.js');_kms('//doug1izaerwt3.cloudfront.net/43e47c426bf1156fddc7b7e065fb563ac1be5bf0.1.js');

    = yield

    = render "layouts/footer"

    - if updated_content["#modal"]
      = updated_content["#modal"]
    - else
      #modal

  - if Rails.env.production?
    :javascript
      var _sf_async_config={uid:25400,domain:"ourcommonplace.com"};
      (function(){
        function loadChartbeat() {
          window._sf_endpt=(new Date()).getTime();
          var e = document.createElement('script');
          e.setAttribute('language', 'javascript');
          e.setAttribute('type', 'text/javascript');
          e.setAttribute('src',
            (("https:" == document.location.protocol) ? "https://a248.e.akamai.net/chartbeat.download.akamai.com/102508/" : "http://static.chartbeat.com/") +
            "js/chartbeat.js");
          document.body.appendChild(e);
        }
        var oldonload = window.onload;
        window.onload = (typeof window.onload != 'function') ?
          loadChartbeat : function() { oldonload(); loadChartbeat(); };
      })();

  %script{:type => "text/javascript"}
    CommonPlace = window.CommonPlace || {};
    CommonPlace.auth_token = "#{form_authenticity_token}";
    CommonPlace.env = "#{Rails.env}";
  :javascript
    function facebook_invite()
    {
      FB.ui({
        method: 'apprequests',
        message: 'Invitation Text Here',
        data: 'tracking_data'
      });
    }
  - if Rails.env.production?
    :javascript
      $(document).ready(function () {
        Exceptional.setHost('exceptional-api.heroku.com');
        Exceptional.setKey('0556a141945715c3deb50a0288ec3bea5417f6bf');
      });
  - if params[:first].present? and current_user.is_facebook_user and $rollout.active?(:facebook_like, current_user)
    :javascript
      $(document).ready(function() { facebook_invite(); });
  - if Rails.env.production?
    :javascript
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23648046-1']);
      _gaq.push(['_setDomainName', '.commonplaceusa.com']);
      _gaq.push(['_trackPageview', location.pathname + location.hash]);
      _gaq.push(['_formAnalysis', {
          onBounce: true,
          minFields: 3
      }]);
      _gaq.push(['_setXDomain', {
          domainName: 'commonplaceusa.com'
      }]);
      _gaq.push(['_trackLoadTime', {
          onBounce: true,
          method: 'event',
          category: 'loadTime'
      }]);
      _gaq.push(['_trackRealBounce', {
          category: 'NoBounce',
          delay: 30
      }]);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

      var _dashboard_project_id = "e6a70fade40ed51da8bdfc4402bf786284b18908";
      (function() {function async_load(){ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = 'true'; s.src = (document.location.protocol == 'https:' ? "https:" : "http:") + '//dtn4rpwzrtdnb.cloudfront.net/dashboard.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);} if (window.attachEvent) window.attachEvent('onload', async_load); else window.addEventListener('load', async_load, false); })();
  %script
    FB.init({
    appId : "#{($FacebookConfig || {})['app_id']}",
    status : true,
    cookie : true,
    xfbml  : true
    });
    function facebook_pass(session)
    {
    return session.uid;
    }
