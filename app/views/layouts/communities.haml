= render :layout => 'layouts/application' do
  - if Rails.env.production?
    %script
      = "mpmetrics.track('Community Home Page', {'community': '#{current_community.slug}'});"
  #main
    #whats-happening
    #say-something
    #community-profiles
      = render 'accounts/info_box'
    = yield :modal
:javascript
  CommonPlace.community = new CommonPlace.Community({ id: #{current_community.id},
  name: "#{current_community.name}"});


  CommonPlace.community.posts.refresh(#{@posts.to_json.html_safe});

  CommonPlace.community.events.refresh(#{@events.to_json.html_safe});

  CommonPlace.community.announcements.refresh(#{@announcements.to_json.html_safe});

  CommonPlace.community.group_posts.refresh(#{@group_posts.to_json.html_safe});

  CommonPlace.community.feeds.refresh(#{@feeds.to_json.html_safe});
  CommonPlace.community.groups.refresh(#{@group_posts.to_json.html_safe});
  CommonPlace.community.users.refresh(#{@users.to_json.html_safe});

  CommonPlace.account = new CommonPlace.Account(#{Serializer::serialize(Account.new(current_user)).to_json.html_safe});

  CommonPlace.env = '#{Rails.env}';
  var oldhash = window.location.hash.slice(1);
  window.location.hash = "/";

  CommonPlace.app = new CommonPlace.MainPageController({community: CommonPlace.community, account: CommonPlace.account});
  CommonPlace.app.runNotifier();
  Backbone.history.start();

  window.location.hash = "/#{params[:backbone_route]}"
  Backbone.history.loadUrl();
  if (oldhash != "" && oldhash != "/") { window.location.hash = oldhash; }

- unless current_user.seen_tour?
  - current_user.toggle!(:seen_tour)
  :javascript
    (new CommonPlace.Tour({el: $("#main")})).render();
